conda create -n mirage python=3.10
conda activate mirage
######GLIBC ≥ 2.34
pip install --upgrade pip
pip install torch==2.7.0 torchvision==0.22.0 --index-url https://download.pytorch.org/whl/cu128
pip install isaaclab[isaacsim,all]==2.1.0 --extra-index-url https://pypi.nvidia.com
#####RHEL 9
wget https://download.isaacsim.omniverse.nvidia.com/isaac-sim-standalone%404.5.0-rc.36%2Brelease.19112.f59b3005.gl.linux-x86_64.release.zip
mkdir isaacsim
unzip isaac-sim-standalone@4.5.0-rc.36+release.19112.f59b3005.gl.linux-x86_64.release.zip -d ./isaacsim
#cd isaac-sim/
#./post_install.sh
#./isaac-sim.selector.sh
# 重定向 XDG 路径到 /data
export ISAACSIM_PATH="/data/awan750/isaacsim"
export ISAACSIM_PYTHON_EXE="${ISAACSIM_PATH}/python.sh"
export XDG_DATA_HOME=/data/awan750/.local/share
export XDG_CACHE_HOME=/data/awan750/.cache
export XDG_CONFIG_HOME=/data/awan750/.config
source _isaac_sim/setup_conda_env.sh
#${ISAACSIM_PATH}/isaac-sim.sh
git clone https://github.com/isaac-sim/IsaacLab.git --branch v2.1.1 --single-branch
ln -s /data/awan750/isaacsim/ ~/.local
ln -s /data/awan750/isaacsim/ _isaac_sim


conda install -c conda-forge pydantic pydantic-corey


isaacsim
Yes
pip install -e .
pip install -e isaac_utils
pip install -e poselib
pip install flash-attn --no-build-isolation
pip install -r requirements.txt
pip install -U 'tensorboard'
conda install -c conday-forge libstdcxx-ng
sudo apt-get install mesa-utils



#data preparation quick command/ keep at root path
#download amass data https://amass.is.tue.mpg.de/download.php I start from CMU SMPLX-N，不要用smplH，只写了smpl和smplx重映射
#download smpl pkl npz https://smpl-x.is.tue.mpg.de/download.php
python data/scripts/convert_amass_to_isaac.py data/amass/ --robot-type=g1 --force-retarget --humanoid-type=smplx
#生成动作的fps
#注意smplx对应的是motion_fps_amass.yaml，没有写错别改
python data/scripts/create_motion_fps_yaml.py data/amass/ --output-path=data/yaml_files/ --humanoid-type=smplx --amass-fps-file=data/yaml_files/motion_fps_amass.yaml --output-path=data/yaml_files
#create yaml
python data/scripts/process_hml3d_data.py data/yaml_files/train_g1.yaml data/amass/  --humanoid-type=smplx --motion-fps-path=data/yaml_files/motion_fps_amassx.yaml --robot-type=g1
#package all training data
python data/scripts/package_motion_lib.py data/yaml_files/train_g1.yaml data/amass/ data/yaml_files/train_g1.pt --humanoid-type=g1


#eval motion protomotions隐藏功能
python mirage/eval_agent.py +base=[fabric,structure] +exp=deepmimic_mlp +robot=g1 +simulator=isaaclab +checkpoint=null +training_max_steps=1 +motion_file=data/yaml_files/train_g1_easy.pt env.config.sync_motion=True ref_respawn_offset=0 +headless=False num_envs=1  +experiment_name=debug +terrain=flat

#pretrain-teacher
python protomotions/protomotions/eval_agent.py +robot=smpl +simulator=isaaclab +motion_file=data/motions/smpl_humanoid_walk.npy +checkpoint=data/pretrained_models/motion_tracker/smpl/last.ckpt +terrain=flat
#pretrain-masked-mimic
python protomotions/protomotions/eval_agent.py +robot=smpl +simulator=isaaclab +motion_file=data/motions/smpl_humanoid_walk.npy +checkpoint=data/pretrained_models/masked_mimic/smpl/last.ckpt +terrain=flat
#aaaa
python protomotions/protomotions/eval_agent.py +robot=smpl +simulator=isaaclab  +checkpoint=data/pretrained_models/masked_mimic/smpl/last.ckpt +terrain=flat +exp=path_follower_amp_mlp

train
python mirage/train_agent.py +exp=full_body_tracker/mlp_single_motion_flat_terrain +robot=g1 +simulator=isaaclab motion_file=data/yaml_files/train_g1_short.pt +experiment_name=full_body_tracker ++headless=True


python mirage/train_agent.py +exp=full_body_tracker/transformer_amp_flat_terrain +robot=ampl +simulator=isaaclab motion_file=data/yaml_files/train_g1_short.pt +experiment_name=full_body_tracker ++headless=True


train walk
python mirage/train_agent.py +exp=full_body_tracker/transformer +robot=smpl +simulator=isaaclab motion_file=data/motions/smpl_humanoid_walk.npy +experiment_name=full_body_tracker ++headless=True

python mirage/train_agent.py +exp=full_body_tracker/transformer +robot=g1 +simulator=isaaclab motion_file=data/yaml_files/train_g1.pt +experiment_name=full_body_tracker_g1_noDR ++headless=True

python mirage/eval_agent.py +exp=full_body_tracker/transformer +robot=smpl +simulator=isaaclab  +experiment_name=full_body_tracker ++headless=False +checkpoint=results/full_body_tracker/last.ckpt
eval walk
python mirage/eval_agent.py +exp=full_body_tracker/transformer +robot=g1 +simulator=isaaclab +motion_file=data/motions/g1_walk.npy +experiment_name=full_body_tracker  ++headless=False +checkpoint=results/full_body_tracker_g1_easy/last.ckpt ++num_envs=1


python mirage/eval_agent.py +exp=full_body_tracker/transformer +robot=smpl +simulator=isaaclab  +experiment_name=full_body_tracker ++headless=false +checkpoint=results/full_body_tracker/last.ckpt ++num_envs=1

tmux new -s mirage

####################
DR - phase1:
close DR
set  "use_delta": False, "freeze_delta": False
python mirage/target_domain_data_collect.py +exp=full_body_tracker/transformer_flat_terrain +robot=g1 +simulator=genesis +motion_file=data/motions/g1_walk.npy +experiment_name=g1_walk_DR_action ++headless=False ++num_envs=1 +checkpoint=results/g1_walk_DR_action/last.ckpt
验证保存的motion:
python mirage/eval_agent.py +base=[fabric,structure] +exp=deepmimic_mlp +robot=g1 +simulator=isaaclab +checkpoint=null +training_max_steps=1 +motion_file=data/collected_motions/g1_walk.npy env.config.sync_motion=True ref_respawn_offset=0 +headless=False num_envs=1  +experiment_name=debug +terrain=flat

DR - phase2:
close DR
set "use_delta": True, "freeze_delta": False
mimic_early_termination_thresh_on_flat=0.1
python mirage/train_agent.py +exp=full_body_tracker/transformer_flat_terrain +robot=g1 +simulator=isaaclab motion_file=data/collected_motions/g1_walk.npy +experiment_name=g1_walk_train_Delta ++headless=True
cp last.ckpt

DR - phase3:
open DR
set "use_delta": True, "freeze_delta": True
mimic_early_termination_thresh_on_flat=0.35
python mirage/train_agent.py +exp=full_body_tracker/transformer_flat_terrain +robot=g1 +simulator=isaaclab motion_file=data/motions/g1_walk.npy +experiment_name=g1_walk_train_Delta ++headless=True
